<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="roomMapper">
	<resultMap type="Room" id="roomResultSet">
		<id column="RONO" property="roNo"/>
		<result column="USNO" property="userNo"/>
		<result column="ROOMS_TITLE" property="roomsTitle"/>
		<result column="MIN_PEOPLE" property="minPeople"/>
		<result column="MAX_PEOPLE" property="maxPeople"/>
		<result column="PRICE" property="price"/>
		<result column="ADD_PRICE" property="addPrice"/>
		<result column="ROOMS_NOTICE" property="roomsNotice"/>
		<result column="ROOMS_TAG" property="roomsTag"/>
		<result column="ROOM_COUNT" property="roomCount"/>
		<result column="BED_COUNT" property="bedCount"/>
		<result column="BATH_COUNT" property="bathCount"/>
		<result column="RESTROOM_COUNT" property="restroomCount"/>
		<result column="FACILITY" property="facility"/>
		<result column="SERVICE" property="service"/>
		<result column="MEAL" property="meal"/>
		<result column="DENY" property="deny"/>
		<result column="DENY_CONTENT" property="denyContent"/>
		<result column="ADD_BASIC" property="addBasic"/>
		<result column="ADD_DETAIL" property="addDetail"/>
		<result column="ADD_REF" property="addRef"/>
		<result column="ZIP_CODE" property="zipCode"/>
		<result column="APPLY_DATE" property="applyDate"/>
		<result column="START_DATE" property="startDate"/>
		<result column="END_DATE" property="endDate"/>
		<result column="OPERATE_DAY" property="operateDay"/>
		<result column="PONO" property="poNo"/>
		<result column="POWER_START" property="powerStart"/>
		<result column="POWER_END" property="powerEnd"/>
		<result column="STATUS" property="status"/>
		<result column="CHECK_IN" property="checkIn"/>
		<result column="CHECK_OUT" property="checkOut"/>
		<result column="DEADLINE" property="deadline"/>
		<result column="ORIGIN_NAME" property="originName"/>
		<result column="CHANGE_NAME" property="changeName"/>
		<result column="FILE_PATH" property="filePath"/>
		<result column="RPNO" property="rpNo"/>
		<result column="POWER_KIND" property="powerKind"/>
		<result column="PERIOD" property="period"/>
		<result column="PRICE" property="powerPrice"/>
	</resultMap>
	
	
	<resultMap type="Room" id="powerResultSet">
		<id column="PONO" property="poNo"/>
		<result column="POWER_KIND" property="powerKind"/>
		<result column="PERIOD" property="period"/>
		<result column="PRICE" property="powerPrice"/>
		
		<result column="ROOMS_TITLE" property="roomsTitle"/>
		<result column="EMAIL" property="email"/>
		<result column="POWER_START" property="powerStart"/>
		<result column="POWER_END" property="powerEnd"/>
		<result column="PONO" property="poNo1"/>
	</resultMap>
	
	<!-- Rooms테이블 + Roomspay테이블 -->
	<resultMap type="Room" id="roomAndRoomspayResultSet">
		<id column="RONO" property="roNo"/>
		<result column="USNO" property="userNo"/>
		<result column="ROOMS_TITLE" property="roomsTitle"/>
		<result column="MIN_PEOPLE" property="minPeople"/>
		<result column="MAX_PEOPLE" property="maxPeople"/>
		<result column="PRICE" property="price"/>
		<result column="ADD_PRICE" property="addPrice"/>
		<result column="ROOMS_NOTICE" property="roomsNotice"/>
		<result column="ROOMS_TAG" property="roomsTag"/>
		<result column="ROOM_COUNT" property="roomCount"/>
		<result column="BED_COUNT" property="bedCount"/>
		<result column="BATH_COUNT" property="bathCount"/>
		<result column="RESTROOM_COUNT" property="restroomCount"/>
		<result column="FACILITY" property="facility"/>
		<result column="SERVICE" property="service"/>
		<result column="MEAL" property="meal"/>
		<result column="DENY" property="deny"/>
		<result column="DENY_CONTENT" property="denyContent"/>
		<result column="ADD_BASIC" property="addBasic"/>
		<result column="ADD_DETAIL" property="addDetail"/>
		<result column="ADD_REF" property="addRef"/>
		<result column="ZIP_CODE" property="zipCode"/>
		<result column="APPLY_DATE" property="applyDate"/>
		<result column="START_DATE" property="startDate"/>
		<result column="END_DATE" property="endDate"/>
		<result column="OPERATE_DAY" property="operateDay"/>
		<result column="PONO" property="poNo"/>
		<result column="POWER_START" property="powerStart"/>
		<result column="POWER_END" property="powerEnd"/>
		<result column="STATUS" property="status"/>
		<result column="CHECK_IN" property="checkIn"/>
		<result column="CHECK_OUT" property="checkOut"/>
		<result column="DEADLINE" property="deadline"/>
		<result column="ORIGIN_NAME" property="originName"/>
		<result column="CHANGE_NAME" property="changeName"/>
		<result column="FILE_PATH" property="filePath"/>
		<result column="ROOMS_NOTICE" property="roomsNotice"/>
		
		
		
		<result column="AMOUNT" property="amount"/>
		<result column="BIRTHDATE" property="birthday"/>
		<result column="PAY_DATE" property="payDate"/>
		<result column="ADD_POINT" property="addPoint"/>
		
		<result column="RESERVE_STATUS" property="reserveStatus"/>
		<result column="USE_POINT" property="usePoint"/>
		<result column="PEOPLE" property="people"/>
		<result column="CONCEPT" property="concept"/>
		<result column="REQUEST" property="request"/>
		<result column="START_DAYS" property="startDays"/>
		<result column="END_DAYS" property="endDays"/>
	</resultMap>
	
	<!-- Attachment테이블 -->
	<resultMap type="Attachment" id="attachmentResultSet">
		<id column="FINO" property="fiNo"/>
		<result column="ORIGIN_NAME" property="originName"/>
		<result column="CHANGE_NAME" property="changeName"/>
		<result column="FILE_PATH" property="filePath"/>
		<result column="UPLOAD_DATE" property="uploadDate"/>
		<result column="STATUS" property="status"/>
		<result column="CATEGORY" property="category"/>
		<result column="RONO" property="roNo"/>
		<result column="EXNO" property="exNo"/>
	</resultMap>
	
	<!-- Review테이블 + Member테이블 + Partner테이블 -->
	<resultMap type="Room" id="reviewAndMemberResultSet">
		<id column="RENO" property="reNo"/>
		<result column="RONO" property="roNo"/>
		<result column="USNO" property="userNo"/>
		<result column="USER_NAME" property="userName"/>
		<result column="REVIEW_TITLE" property="reTitle"/>
		<result column="REVIEW_CONTENT" property="reContent"/>
		<result column="CREATE_DATE" property="reviewDate"/>
		<result column="SCORE" property="score"/>
		<result column="REPLY" property="reply"/>
		<result column="REPLY_DATE" property="replyDate"/>
		<result column="REPLY_STATUS" property="replyStatus"/>

		<result column="ORIGIN_NAME" property="usOriginName"/>
		<result column="CHANGE_NAME" property="usChangeName"/>
	</resultMap>
	
	<select id="selectListCount" resultType="_int" parameterType="_int">
		select count(*)
		  from rooms
		 where usno = #{userNo}
	</select>
	
	<select id="selectRoomsList" resultMap="roomResultSet" parameterType="_int">
		select *
	      from rooms 
	     where usno = #{userNo}
	</select>
	
	<select id="selectRoom" resultMap="roomResultSet" parameterType="_int">
		select *
		  from rooms
		 where rono = #{roNo}
	</select>
	
	<!-- 숙소등록 -->
	<insert id="insertRoom" parameterType="Room">
		insert into rooms
		values(rono.nextval, #{userNo}, #{roomsTitle}, #{minPeople}, #{maxPeople}, #{price}, 10000, #{roomsTag}, 
				#{roomCount}, #{bedCount}, #{bathCount}, #{restroomCount}, #{facility}, #{service}, 
				#{meal}, null, null, #{addBasic}, #{addDetail},
			   #{addRef}, #{zipCode}, sysdate, null, null, null, null, null, null, 2, #{checkIn}, #{checkOut}, #{deadline},
			   #{originName}, #{changeName}, #{filePath}, #{roomsNotice})
	</insert>
	
	<!-- 숙소rono -->
	<select id="selectRono" resultType="_int">	
		select rono
	      from rooms
	     where rownum = 1
	     order by rono desc
	</select>
	
	<!-- 숙소등록 상세이미지  -->
	<insert id="insertAttachment" parameterType="Attachment">
		insert into attachment
		values(fino.nextval, #{originName}, #{changeName}, #{filePath}, sysdate, 'Y', 1, rono.currval, null)
	</insert>
	
	<select id="selectRoomOkeyListCount" resultType="_int" parameterType="_int">
		select count(*) 
		  from rooms
		 where usno=#{usNo} and status=1
	</select>
	
	<select id="selectOkeyList" resultMap="roomAndRoomspayResultSet" parameterType="_int">
		select r.status, r.rooms_title, r.usno, r.rono, r.add_basic,
			   count(p.rono) as totalSal
	      from rooms r
	      left join roomspay p on (r.rono=p.rono)
	     where r.status=1 and r.pono is null
	     group by r.status, r.rooms_title, r.usno, r.rono, r.add_basic
	    having r.usno = #{userNo}
	     order by totalSal desc
	</select>
	
	<update id="updateRoomPower" parameterType="Room">
		update rooms
		   set pono=#{poNo}, power_start=#{powerStart}, power_end=#{powerEnd}
	     where rono=#{roNo}
	</update>
	
	
	
	
	<!-- 파워관리 시작-->
	<select id="selectPowerList" resultMap="powerResultSet">
		select *
	      from power
	</select>
	
		
	<insert id="insertPower" parameterType="Room">
		insert into power
		values(pono.nextval, #{powerKind}, #{period}, #{powerPrice})
		 order by price asc
	</insert>
	
	<update id="updatePower" parameterType="Room">
	
		update power
		   set POWER_KIND=#{powerKind},
		       PERIOD=#{period},
		       PRICE=#{powerPrice}
		 where pono=#{poNo}
	
	</update>
	
	<select id="selectPower" parameterType="_int" resultMap="powerResultSet">
		select *
		  from power
		 where pono= #{pno}
	      
	</select>
	
	<select id="aSelectPowerListCount" resultType="_int">
		select count(*)
		  from POWER P
		  JOIN ROOMS R ON r.pono = p.pono
		  JOIN MEMBER M ON r.usno = m.usno
		 WHERE R.PONO > 0
	</select>
	
	<select id="selectPowerRoomList" resultMap="powerResultSet">
	
	
		select P.PONO, P.POWER_KIND, R.ROOMS_TITLE, M.EMAIL, P.PERIOD, R.POWER_START, R.POWER_END, R.PONO
		  FROM POWER P
		  JOIN ROOMS R ON r.pono = p.pono
		  JOIN MEMBER M ON r.usno = m.usno
		 WHERE R.PONO > 0 and R.POWER_END >= SYSDATE
		
	
	</select>
	<!-- 파워관리 시작-->
	
	
	<!-- 숙소관리 시작-->
	
	<select id="selectListRoomsWaitCount" resultType="_int">
		select count(*)
		  from rooms
		 where status = 2
	</select>
	
	<select id="selectRoomsWaitList" resultMap="roomResultSet">
		select *
		  from rooms
		 where status = 2
	</select>
	
	<select id="selectListRoomsOkayCount" resultType="_int">
		select count(*)
		  from rooms
		 where status = 1
	</select>
	
	<select id="selectRoomsOkayList" resultMap="roomResultSet">
		select *
		  from rooms
		 where status = 1
	</select>
	
		<select id="selectRoomWaitDetail" resultMap="roomResultSet" parameterType="_int">
		select *
		  from rooms
		 where rono = #{rno}
	</select>
	
	<update id="updateOkay" parameterType="_int">
	
		update rooms
		   set STATUS = 1
		 where RONO=#{rno}
	
	</update>
	
	<update id="updateReject" parameterType="Room">
	
		update rooms
		   set STATUS = 3,
		       DENY=#{deny},
		       DENY_CONTENT=#{denyContent}
		 where RONO=#{roNo}
	
	</update>
	
	<!-- 숙소관리 끝-->

	<!-- 숙소조회 시작 -->
	<select id="selectRoomSearch" parameterType="Room" resultMap="roomAndRoomspayResultSet">
		SELECT *
		  FROM ROOMS
		 WHERE RONO NOT IN (
		                    SELECT R.RONO
		                    FROM ROOMS R
		                    JOIN ROOMSPAY P ON(R.RONO = P.RONO)
		                    WHERE ((#{startDays} BETWEEN P.START_DAYS AND (P.END_DAYS-1))
		                        or (#{endDays} BETWEEN (P.START_DAYS+1) AND P.END_DAYS))
							)
          AND (#{people} BETWEEN MIN_PEOPLE AND MAX_PEOPLE)
          AND ((ADD_BASIC LIKE '%' || #{addBasic} || '%') OR (ADD_REF LIKE '%' || #{addBasic} || '%'))
        ORDER BY RONO
	</select>

	<select id="selectDetailImages" parameterType="_int" resultMap="attachmentResultSet">
		SELECT *
		 FROM ATTACHMENT
		WHERE RONO = #{roNo}
	</select>
	
	<select id="selectReviewList" parameterType="_int" resultMap="reviewAndMemberResultSet">
		SELECT *
		  FROM REVIEW
		  JOIN MEMBER USING (USNO)
		  JOIN PARTNER USING (PANO)
		 WHERE RONO=#{roNo}
	</select>

	<!-- 숙소조회 끝 -->

























</mapper>
